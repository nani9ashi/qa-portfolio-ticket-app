# DEFECT-001 依頼者が他人チケット詳細を参照できる

## 基本情報
- 状態：検証済
- 重要度：Critical
- 優先度：High
- 発見日：2026-01-13
- 発見者：仁後慎太郎
- 検出環境：Win11/Chrome
- 検出ビルド：app-defect-idor
- 関連テストケース：TC-002, TC-003
- 証跡：
  - evidence/screenshots/TR-0001.png（TC-002）
  - evidence/screenshots/TR-0002.png（TC-003）
- 備考：

## 概要
Requester（依頼者）が、他Requesterのチケット詳細を URL直アクセス／ID書き換えにより閲覧できる。

## 前提（テストデータ）
- requester1 でログイン可能
- requester2 所有のチケットが存在する
- チケット詳細URLが `/tickets/<id>/` 形式である

## 再現手順
### パターンA（TC-002：直アクセス）
1. requester1 でログインする
2. requester2 所有チケットの詳細URL（`/tickets/<other_id>/`）をアドレスバーに貼り付けて開く
3. 他人チケットの詳細が表示されることを確認する

### パターンB（TC-003：ID推測／書き換え）
1. requester1 でログインする
2. 自分のチケット詳細（`/tickets/<my_id>/`）を開く
3. URLの `<my_id>` を `<other_id>` に書き換えてアクセスする
4. 他人チケットの詳細が表示されることを確認する

## 期待結果
- いずれの手順でもアクセス拒否（403等）となり、他人チケットのタイトル/本文/添付/履歴等は閲覧できない。

## 実際結果
- いずれの手順でも他人チケット詳細が表示され、内容を閲覧できた。

## 影響範囲
- ロール境界を越えた情報閲覧が可能となり、情報漏えいリスクがある。
- チケットIDが推測可能（連番等）な場合、被害範囲が拡大する恐れがある。

## 原因仮説（推測）
- サーバ側で「Requesterは自分のチケットのみ参照可能」のチェックが欠落、または条件分岐が無効化されている可能性。

## 修正方針（案）
- チケット詳細取得時に、Requesterの場合は `ticket.requester == request.user` を必ず検証し、満たさない場合は forbidden表示 を返す。

## 回帰観点
- 修正後、TC-002 と TC-003 を再実行して Pass となること。
- 影響が疑われる範囲として、一覧表示（TC-027）で他人チケットが出ないことも確認する（必要に応じて）。

## 修正内容
- 修正ビルド：app-v0.3
- 修正概要：IDORを無効化し、Requesterの参照認可（自分のチケットのみ）を復元した。

## リテスト／回帰結果
- TR-0003（TC-002 / 回帰）：合格（他人チケット詳細は403）
- TR-0004（TC-003 / 回帰）：合格（URLのID改変でも403）

## 状態遷移
新規（起票） → 修正済（修正コミット作成） → 検証済（TR-0003/0004 合格で確認）